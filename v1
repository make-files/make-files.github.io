#!/usr/bin/env bash
set -euo pipefail

export MF_PROJECT_ROOT="$(pwd)"

MF_VERSION="1"
MF_ROOT="$MF_PROJECT_ROOT/.makefiles"
MF="$MF_ROOT/lib/core/bin/mf"

if [[ ! -d "$MF_ROOT/lib/core" ]]; then
    tmpdir="$(mktemp -d)"
    trap "rm -rf '$tmpdir'" EXIT

    curl \
        --fail \
        --silent \
        --show-error \
        --location \
        --create-dirs \
        --output "$tmpdir/archive.zip" \
        "https://github.com/make-files/lib-core/archive/v$MF_VERSION.zip?nonce=$(uuidgen)"

    unzip -q "$tmpdir/archive.zip" -d "$tmpdir"
    mkdir -p "$MF_ROOT/lib"
    mv "$tmpdir/lib-core-$MF_VERSION" "$MF_ROOT/lib/core"
    "$MF" exec-hook core install
fi

"$MF" build "$1"
