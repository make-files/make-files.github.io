#!/usr/bin/env bash
set -euo pipefail

export MF_VERSION="${MF_VERSION:-1}"
export MF_PATH_ROOT="${MF_PATH_ROOT:-$(pwd)/.makefiles}"

if [[ ! -d "$MF_PATH_ROOT/lib/core" ]]; then
    echo "downloading makefiles.dev core library"

    tmpdir="$(mktemp -d)"
    trap "rm -rf '$tmpdir'" EXIT

    curl \
        --fail \
        --silent \
        --show-error \
        --location \
        --create-dirs \
        --output "$tmpdir/archive.zip" \
        "https://github.com/make-files/lib-core/archive/v$MF_VERSION.zip?nonce=$(uuidgen)"

    echo "installing makefiles.dev core library"

    unzip -q "$tmpdir/archive.zip" -d "$tmpdir"
    "$tmpdir/lib-core-$MF_VERSION/bin/install"
fi

"$MF_PATH_ROOT/bin/build" $1
